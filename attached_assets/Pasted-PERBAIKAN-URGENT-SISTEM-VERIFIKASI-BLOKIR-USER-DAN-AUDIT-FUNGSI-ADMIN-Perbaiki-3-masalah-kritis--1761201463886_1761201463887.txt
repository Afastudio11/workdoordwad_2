PERBAIKAN URGENT: SISTEM VERIFIKASI, BLOKIR USER, DAN AUDIT FUNGSI ADMIN

Perbaiki 3 masalah kritis berikut dan lakukan audit menyeluruh pada semua fungsi admin:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MASALAH 1: EMPLOYER BELUM TERVERIFIKASI MASIH BISA POSTING LOWONGAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Problem:** User dengan status "Belum Verifikasi" masih bisa mengakses halaman Post Job dan memposting lowongan. Ini harus diblokir total.

**Solusi yang harus diimplementasikan:**

1. **Update Database Schema**
   - Tambahkan field verification_status (pending/verified/rejected) di tabel employers
   - Tambahkan field verified_at, verified_by, rejection_reason
   - Set default value = 'pending' untuk registrasi baru

2. **Server-Side Protection (CRITICAL)**
   - Buat middleware yang CEK status verifikasi SEBELUM akses semua fitur employer
   - Terapkan middleware ke SEMUA route employer yang memerlukan verifikasi:
     - Post job
     - Edit job
     - Delete job
     - View applicants
     - Change subscription plan
     - Upload files
   - Jika verification_status != 'verified', BLOCK akses dan redirect dengan error message

3. **Dashboard Employer - Banner Warning**
   - Tampilkan banner besar di atas dashboard jika status = 'pending':
     - Icon: â³
     - Pesan: "Akun Anda Sedang Dalam Proses Verifikasi"
     - Detail: "Admin kami sedang memverifikasi akun perusahaan Anda. Anda akan menerima email notifikasi dalam 1x24 jam. **Anda belum dapat memposting lowongan hingga akun terverifikasi.**"
     - Tampilkan checklist status verifikasi
   - Jika status = 'rejected':
     - Icon: âŒ
     - Pesan: "Verifikasi Akun Ditolak"
     - Tampilkan alasan penolakan
     - Button: "Update & Kirim Ulang"

4. **Halaman Post Job - Blocked State**
   - Jika user belum verified, JANGAN tampilkan form
   - Tampilkan halaman blocked dengan:
     - Icon kunci besar ğŸ”’
     - Heading: "Fitur Posting Lowongan Terkunci"
     - Pesan: "Akun perusahaan Anda masih dalam proses verifikasi oleh admin. Anda dapat memposting lowongan kerja setelah akun terverifikasi."
     - Card info dengan status verifikasi terkini
     - Button: "Kembali ke Dashboard" dan "Hubungi Admin"

5. **Client-Side Check (Additional Protection)**
   - Tambahkan AJAX check sebelum submit form apapun
   - Jika response status != 'verified', tampilkan modal error
   - Disable semua button yang terkait posting job jika belum verified

6. **Admin Side - Fungsi Verifikasi**
   - Admin bisa klik button "Verifikasi" di halaman employers
   - Update verification_status = 'verified'
   - Catat verified_at dan verified_by (admin ID)
   - Kirim email notifikasi ke employer
   - Employer langsung bisa posting job setelah verified

**Test Case:**
- Registrasi employer baru â†’ status harus 'pending'
- Coba akses /employer/post-job â†’ harus redirect/block
- Coba submit POST request ke /employer/post-job â†’ harus return error 403
- Admin verify employer â†’ status berubah 'verified'
- Employer coba akses /employer/post-job lagi â†’ sekarang harus bisa

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MASALAH 2: TOMBOL BLOKIR USER TIDAK BERFUNGSI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Problem:** Admin klik tombol "Blokir" tapi user yang diblokir masih bisa login dan mengakses akun seperti biasa.

**Solusi yang harus diimplementasikan:**

1. **Update Database Schema**
   - Tambahkan field is_blocked (BOOLEAN, default FALSE) di tabel employers DAN job_seekers
   - Tambahkan field blocked_at, blocked_by, block_reason

2. **Admin: Fungsi Blokir User (Server-Side)**
   - Route POST /admin/users/block/:id
   - Update is_blocked = TRUE di database
   - Catat blocked_at (timestamp), blocked_by (admin ID), block_reason
   - **PENTING:** HAPUS semua session aktif user tersebut dari tabel sessions
   - Kirim email notifikasi ke user yang diblokir
   - Log aktivitas admin ke admin_activity_logs
   - Return success response

3. **Admin: Fungsi Buka Blokir User**
   - Route POST /admin/users/unblock/:id
   - Update is_blocked = FALSE
   - Clear blocked_at, blocked_by, block_reason
   - Kirim email notifikasi bahwa akun dibuka
   - Log aktivitas admin

4. **Middleware: Cek Status Blokir di SETIAP Request**
   - Buat middleware checkBlockedUser
   - Jalankan di SETIAP request dari employer/job_seeker
   - Query database untuk cek is_blocked
   - Jika is_blocked = TRUE:
     - Destroy session user
     - Redirect ke halaman "Akun Diblokir"
     - Jangan biarkan user akses apapun

5. **Login Process: Cek Blokir Saat Login**
   - Saat user input email + password untuk login
   - Setelah password match, CEK is_blocked dari database
   - Jika is_blocked = TRUE:
     - TOLAK login
     - Return error: "Akun Anda telah diblokir oleh admin"
     - Tampilkan alasan blokir
   - Jangan buat session jika user diblokir

6. **Halaman Khusus: Akun Diblokir**
   - URL: /blocked
   - Tampilan:
     - Icon besar: ğŸš«
     - Heading: "Akun Anda Telah Diblokir"
     - Pesan: "Akses ke akun Anda telah diblokir oleh administrator Pintu Kerja"
     - Box alasan pemblokiran (jika ada)
     - Info kontak support
     - Button: "Hubungi Support"
   - User TIDAK bisa kembali ke dashboard atau halaman lain

7. **Admin UI: Button Blokir/Buka Blokir**
   - Pastikan button ini benar-benar trigger POST request ke /admin/users/block/:id
   - Tambahkan konfirmasi: "Apakah Anda yakin ingin memblokir [Nama User]?"
   - Modal input untuk alasan blokir (wajib diisi)
   - Setelah berhasil, reload halaman atau update UI
   - Button berubah dari "Blokir" menjadi "Buka Blokir" setelah user diblokir

**Test Case:**
- Admin klik "Blokir" pada user ID 123
- Database updated: is_blocked = TRUE untuk user 123
- User 123 yang sedang login â†’ session destroyed, redirect ke /blocked
- User 123 coba login lagi â†’ login ditolak dengan error message
- User 123 coba akses URL dashboard langsung â†’ redirect ke /blocked
- Admin klik "Buka Blokir" â†’ is_blocked = FALSE
- User 123 sekarang bisa login dan akses normal

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MASALAH 3: AUDIT SEMUA FUNGSI ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Lakukan pengecekan menyeluruh dan pastikan SEMUA fungsi admin berikut bekerja dengan baik:**

## A. USER MANAGEMENT - EMPLOYER

**Checklist yang harus berfungsi:**
- âœ… View list all employers dengan pagination (20 per page)
- âœ… Search employers by name, email, company name
- âœ… Filter employers by: verification status, subscription plan, industry, city
- âœ… Sort by: registration date, company name, plan type
- âœ… View employer detail (full profile, company info, documents)
- âœ… **Verify employer** â†’ Update status ke 'verified', kirim email
- âœ… **Reject employer** â†’ Update status ke 'rejected', input reason, kirim email
- âœ… **Block employer** â†’ Set is_blocked = TRUE, destroy session, kirim email
- âœ… **Unblock employer** â†’ Set is_blocked = FALSE, kirim email
- âœ… **Delete employer** â†’ Soft delete atau hard delete dengan konfirmasi
- âœ… **Change subscription plan manually** â†’ Upgrade/downgrade plan employer
- âœ… **View employer's posted jobs** â†’ List semua lowongan yang dipost employer ini
- âœ… **View employer's payment history** â†’ List semua transaksi pembayaran
- âœ… **Manually extend subscription** â†’ Tambah durasi subscription

**Test setiap fungsi:**
- Klik "Verify" pada employer pending â†’ Status berubah, email terkirim
- Klik "Block" â†’ User tidak bisa login lagi
- Klik "Delete" â†’ Data terhapus atau soft deleted
- Search "PT Teknologi" â†’ Hasil filter yang sesuai
- Filter "Verified + Premium" â†’ Hanya tampil employer verified dengan plan premium

## B. USER MANAGEMENT - JOB SEEKER

**Checklist yang harus berfungsi:**
- âœ… View list all job seekers dengan pagination
- âœ… Search job seekers by name, email, skills
- âœ… Filter by: city, education level, experience level, join date
- âœ… View job seeker profile (CV, personal info, aplikasi yang dikirim)
- âœ… **Block job seeker** â†’ Set is_blocked = TRUE
- âœ… **Unblock job seeker** â†’ Set is_blocked = FALSE
- âœ… **Delete job seeker** â†’ Hapus akun
- âœ… **View job seeker's applications** â†’ List semua lowongan yang dilamar
- âœ… **Download job seeker's CV**

**Test:**
- Klik view profile job seeker â†’ Bisa lihat CV dan aplikasi
- Klik "Block" â†’ Job seeker tidak bisa login
- Search berdasarkan skills â†’ Filter berfungsi

## C. USER MANAGEMENT - ADMIN

**Checklist yang harus berfungsi:**
- âœ… View list all admins dengan role (super_admin, moderator, finance)
- âœ… **Add new admin** â†’ Input email, name, password, pilih role
- âœ… **Edit admin role** â†’ Ubah permission
- âœ… **Delete admin** â†’ Hapus admin (TIDAK bisa delete diri sendiri)
- âœ… **View admin activity logs** â†’ List semua aktivitas admin (who did what when)

**Test:**
- Tambah admin baru role "Moderator" â†’ Berhasil create
- Login dengan admin baru â†’ Permissions sesuai role
- Coba delete diri sendiri â†’ Harus error/blocked

## D. JOB MANAGEMENT

**Checklist yang harus berfungsi:**
- âœ… View all jobs (active, closed, expired) dengan pagination
- âœ… Search jobs by title, company, location
- âœ… Filter by: status, category, job type, salary range, posting date
- âœ… **View job detail** â†’ Full description, applicants
- âœ… **Edit job** â†’ Admin bisa edit informasi lowongan
- âœ… **Delete job** â†’ Hapus lowongan
- âœ… **Change job status** â†’ Set active/closed/expired manually
- âœ… **Feature job** â†’ Set featured = TRUE (premium feature)
- âœ… **View job applicants** â†’ List semua yang melamar ke job ini
- âœ… **AI Moderation Queue** â†’ Approve/reject lowongan dari AI scraping

**Test:**
- Filter "Technology + Jakarta + Active" â†’ Hasil sesuai
- Edit job title â†’ Perubahan tersimpan
- Feature job â†’ Job muncul di top search dengan badge

## E. FINANCIAL MANAGEMENT

**Checklist yang harus berfungsi:**
- âœ… View all transactions dengan pagination
- âœ… Filter by: payment status (pending/success/failed), date range, amount
- âœ… **Approve manual payment** â†’ Update status dari pending ke success
- âœ… **Reject payment** â†’ Update status ke failed, input reason
- âœ… **View invoice detail** â†’ Download invoice PDF
- âœ… **Process refund** â†’ Approve refund request, update balance
- âœ… **View revenue reports** â†’ Chart dan statistik (daily, weekly, monthly)
- âœ… **Export transactions** â†’ Download CSV/Excel

**Test:**
- Approve payment â†’ Subscription employer aktif
- Process refund â†’ Status berubah, email terkirim
- Export transactions bulan ini â†’ File CSV berhasil didownload

## F. FRAUD & REPORT MANAGEMENT

**Checklist yang harus berfungsi:**
- âœ… View all fraud reports dari users
- âœ… **View report detail** â†’ Lihat job/company yang dilaporkan + reason
- âœ… **Investigate report** â†’ Mark as "under investigation"
- âœ… **Block reported job/company** â†’ Blokir jika terbukti fraud
- âœ… **Mark as false report** â†’ Close report jika tidak valid
- âœ… **Resolve report** â†’ Mark as resolved dengan action taken

**Test:**
- Buka report "Scam job posting" â†’ Lihat detail
- Block job yang dilaporkan â†’ Job tidak tampil lagi di public

## G. SYSTEM SETTINGS & LOGS

**Checklist yang harus berfungsi:**
- âœ… **View error logs** â†’ List semua error backend dengan timestamp
- âœ… **Clear old logs** â†’ Hapus logs >30 hari
- âœ… **View activity logs** â†’ Track semua aksi admin (siapa, kapan, apa)
- âœ… **Configure AI scraper** â†’ Enable/disable per platform, set schedule
- âœ… **Email templates management** â†’ Edit template email notifikasi
- âœ… **Site maintenance mode** â†’ Enable/disable maintenance

**Test:**
- View error logs â†’ Tampil list error
- Enable maintenance mode â†’ Website tampil halaman maintenance

## H. DASHBOARD STATISTICS

**Pastikan semua card di dashboard admin menampilkan data REAL dari database:**
- âœ… Total Pendapatan (bulan ini) â†’ Query SUM dari transactions
- âœ… Total Lowongan Premium Aktif â†’ Query COUNT dari jobs WHERE featured=TRUE
- âœ… Antrean Moderasi AI â†’ Query COUNT dari ai_scraped_jobs WHERE status='pending'
- âœ… Total User â†’ Query COUNT dari employers + job_seekers
- âœ… Users Diblokir â†’ Query COUNT WHERE is_blocked=TRUE
- âœ… Verifikasi Tertunda â†’ Query COUNT WHERE verification_status='pending'
- âœ… Error Log Backend â†’ Query COUNT dari error_logs WHERE resolved=FALSE

**Test:**
- Verify 1 employer â†’ Card "Verifikasi Tertunda" berkurang 1
- Block 1 user â†’ Card "Users Diblokir" bertambah 1
- Payment berhasil â†’ Card "Total Pendapatan" bertambah sesuai amount

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OUTPUT YANG DIHARAPKAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Setelah perbaikan selesai, lakukan testing dan berikan laporan:

1. âœ… **Verifikasi akun employer benar-benar berfungsi**
   - User pending tidak bisa posting job
   - Halaman post job menampilkan blocked message
   - Setelah admin verify, user bisa posting

2. âœ… **Blokir user benar-benar berfungsi**
   - User yang diblokir tidak bisa login
   - User yang sedang login langsung logout paksa
   - Button blokir/unblock bekerja dengan sempurna

3. âœ… **Semua fungsi admin tested dan berfungsi**
   - Tidak ada button yang tidak berfungsi
   - Semua CRUD operations (Create, Read, Update, Delete) bekerja
   - Semua filter, search, pagination bekerja
   - Email notifications terkirim untuk setiap aksi penting

4. âœ… **Dashboard statistics menampilkan data real-time**
   - Semua angka di card dashboard akurat
   - Click card redirect ke halaman detail yang benar

5. âœ… **Error handling yang baik**
   - Jika terjadi error, tampilkan pesan yang jelas
   - Log error ke database untuk debugging

**Dokumentasikan semua perbaikan yang dilakukan dan bug yang ditemukan selama testing.**

**PRIORITAS TERTINGGI:**
1. Fix verifikasi employer (CRITICAL - revenue blocking issue)
2. Fix blokir user (CRITICAL - security issue)
3. Test semua fungsi admin (HIGH - operational issue)
